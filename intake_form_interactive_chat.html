<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intake Form Chat Interface</title>
    <style>
        /* Your existing CSS code */
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div class="chat-container" id="chat-container">
        <!-- Your existing HTML code -->
    </div>

    <script>
        // Your existing JavaScript code

        async function saveToGoogleDrive(filename, content) {
            const clientId = 'YOUR_CLIENT_ID'; // Replace with your client ID
            const apiKey = 'YOUR_API_KEY'; // Replace with your API key
            const scopes = 'https://www.googleapis.com/auth/drive.file';

            try {
                await gapi.load('client:auth2');
                await gapi.client.init({ apiKey, clientId, scope: scopes });
                await gapi.auth2.getAuthInstance().signIn();

                const fileMetadata = {
                    'name': filename,
                    'parents': ['1YWXuK5lKuAtD_WLOWri-2QY050eWk9gf'] // Replace with your folder ID
                };
                const media = {
                    mimeType: 'text/csv',
                    body: content
                };

                const response = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    media: media,
                    fields: 'id'
                });

                console.log('File ID: ' + response.result.id);
            } catch (error) {
                console.error('Error uploading file:', error);
            }
        }

        function handleFormCompletion() {
            const csvContent = Object.values(responses).join(',');
            const timestamp = new Date().toISOString();
            const filename = `intake_form_${timestamp}.csv`;

            saveToGoogleDrive(filename, csvContent);

            // Reset form for next intake
            currentQuestionIndex = 0;
            responses = {};
            document.getElementById('chat-container').innerHTML = `
                <div class="chat-entry">
                    <span class="robot"></span>
                    <div class="chat-bubble left">
                        <span id="welcome-message">Welcome! Would you please register by filling this form?</span>
                    </div>
                </div>
                <div class="chat-entry">
                    <span class="robot"></span>
                    <div class="chat-bubble left">
                        <span id="bot-message">Hello! What is your full name?</span>
                    </div>
                </div>
                <div class="input-container" id="input-container">
                    <input type="text" id="user-input" placeholder="Type your answer here" onkeypress="handleKeyPress(event)">
                    <button onclick="handleUserInput()">Send</button>
                </div>
            `;
        }

        function handleUserInput(option = null) {
            const userInput = option || document.getElementById('user-input').value;
            if (userInput.trim() === "") return;

            // Validate user input
            if (!validateInput(userInput, currentQuestionIndex)) return;

            // Display user input
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-bubble right';
            userMessage.textContent = userInput;
            document.getElementById('chat-container').appendChild(userMessage);

            // Store response
            const question = questions[currentQuestionIndex];
            responses[question] = userInput;

            // Clear input field
            document.getElementById('user-input').value = "";

            // Move to next question
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                const chatEntry = document.createElement('div');
                chatEntry.className = 'chat-entry';
                const botEmoji = document.createElement('span');
                botEmoji.className = 'robot';
                botEmoji.textContent = '';
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-bubble left';
                botMessage.innerHTML = `<span>${questions[currentQuestionIndex]}</span>`;
                chatEntry.appendChild(botEmoji);
                chatEntry.appendChild(botMessage);
                document.getElementById('chat-container').appendChild(chatEntry);
                speakText(questions[currentQuestionIndex]);

                // Show options for the affiliation question
                if (currentQuestionIndex === 3) {
                    showAffiliationOptions();
                } else {
                    moveInputContainerToEnd();
                }
            } else {
                // Form submission simulation
                const chatEntry = document.createElement('div');
                chatEntry.className = 'chat-entry';
                const botEmoji = document.createElement('span');
                botEmoji.className = 'robot';
                botEmoji.textContent = '';
                const thankYouMessage = document.createElement('div');
                thankYouMessage.className = 'chat-bubble left';
                thankYouMessage.innerHTML = `<span>Thank you!</span>`;
                chatEntry.appendChild(botEmoji);
                chatEntry.appendChild(thankYouMessage);
                document.getElementById('chat-container').appendChild(chatEntry);
                speakText("Thank you!");

                handleFormCompletion();
            }

            // Scroll to the bottom of the chat container
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        // Your existing functions (speakText, validateInput, repeatQuestion, etc.)

    </script>
</body>
</html>
